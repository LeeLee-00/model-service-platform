services:

  minio:
    container_name: minio
    image: minio/minio:latest
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD}
    volumes:
      - minio-data:/data
    ports:
      - 9000:9000
      - 9001:9001
    command: server /data --console-address ":9001"
    networks:
      - nginx

  minio-init:
    container_name: minio-init
    image: minio/mc:latest
    depends_on:
      - minio
    entrypoint: >
      /bin/sh -c "
        until mc alias set local http://minio:9000 ${MINIO_ROOT_USER} ${MINIO_ROOT_PASSWORD}; do sleep 2; done &&
        until mc admin info local; do sleep 2; done &&
        mc mb local/models || true &&
        mc admin user add local ${MINIO_SVC_USER} ${MINIO_SVC_PASSWORD} || true &&
        mc admin policy create local rw-policy /policies/rw-policy.json || true &&
        mc admin policy attach local --user ${MINIO_SVC_USER} rw-policy || true
      "
    env_file:
      - .env
    volumes:
      - ./minio/rw-policy.json:/policies/rw-policy.json:ro
    networks:
      - nginx

volumes:
  minio-data:

networks:
  nginx:
    name: model-service_nginx